<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Pipeline Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-2xl mt-10 p-8 bg-white rounded-xl shadow-md">

        <h1 class="text-3xl font-bold text-gray-800 mb-2">ETL Pipeline Configuration</h1>
        <p class="text-gray-500 mb-8">Change application settings here. Changes will be applied immediately.</p>

        <form id="config-form">
            <!-- Scheduler Settings -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Scheduler Settings</h2>
                <div class="mb-4">
                    <label for="interval-minutes" class="block text-sm font-medium text-gray-600 mb-1">Full Sync Interval (minutes)</label>
                    <input type="number" id="interval-minutes" name="interval_minutes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 60" required>
                    <p class="text-xs text-gray-500 mt-1">How often the full data synchronization job will run.</p>
                </div>
            </div>

            <!-- ETL Settings -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">ETL Settings</h2>
                <div class="mb-4">
                    <label for="chunk-size" class="block text-sm font-medium text-gray-600 mb-1">Data Chunk Size</label>
                    <input type="number" id="chunk-size" name="chunk_size" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 1000" required>
                    <p class="text-xs text-gray-500 mt-1">The number of rows to fetch from the database in a single batch.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-end">
                <button type="submit" id="save-button" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                    Save Settings
                </button>
            </div>
        </form>

        <!-- Status Message -->
        <div id="status-message" class="mt-6 text-sm font-medium text-center"></div>

    </div>

    <script>
        const form = document.getElementById('config-form');
        const intervalInput = document.getElementById('interval-minutes');
        const chunkSizeInput = document.getElementById('chunk-size');
        const statusMessage = document.getElementById('status-message');
        const saveButton = document.getElementById('save-button');

        // Function to load the current configuration from the API
        async function loadConfig() {
            try {
                const response = await fetch('/api/v1/config');
                if (!response.ok) {
                    throw new Error('Failed to load configuration.');
                }
                const config = await response.json();
                
                // Populate the form with the loaded values
                intervalInput.value = config.scheduler?.interval_minutes || 60;
                chunkSizeInput.value = config.etl?.chunk_size || 1000;

            } catch (error) {
                console.error('Error loading config:', error);
                statusMessage.textContent = 'Error: Could not load current settings.';
                statusMessage.className = 'mt-6 text-sm font-medium text-center text-red-600';
            }
        }

        // Function to handle saving the new configuration
        async function saveConfig(event) {
            event.preventDefault(); // Prevent the form from submitting traditionally
            
            // Show a saving state on the button
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            statusMessage.textContent = '';

            // Construct the new config object from form values
            const newConfig = {
                scheduler: {
                    interval_minutes: parseInt(intervalInput.value, 10)
                },
                etl: {
                    chunk_size: parseInt(chunkSizeInput.value, 10)
                }
            };

            try {
                const response = await fetch('/api/v1/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newConfig),
                });

                if (!response.ok) {
                    throw new Error('Server responded with an error.');
                }

                const result = await response.json();
                statusMessage.textContent = result.message || 'Settings saved successfully!';
                statusMessage.className = 'mt-6 text-sm font-medium text-center text-green-600';

            } catch (error) {
                console.error('Error saving config:', error);
                statusMessage.textContent = 'Error: Could not save settings.';
                statusMessage.className = 'mt-6 text-sm font-medium text-center text-red-600';
            } finally {
                // Restore button state
                saveButton.disabled = false;
                saveButton.textContent = 'Save Settings';
            }
        }

        // Attach event listeners
        document.addEventListener('DOMContentLoaded', loadConfig);
        form.addEventListener('submit', saveConfig);
    </script>

</body>
</html>
